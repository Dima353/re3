name: reVC cmake devkitA64 (Nintendo Switch)

on:
  pull_request:
    branches: [ miami ]
  push:
    branches: [ miami ]
  release:
    types: [ published ]

jobs:
  build-nintendo-switch-release:
    runs-on: ubuntu-latest
    container: devkitpro/devkita64:latest
    
    steps:
      - name: Checkout Miami branch
        uses: actions/checkout@v4
        with:
          ref: miami
          submodules: 'recursive'
          fetch-depth: 0
          
      - name: Build files
        run: |
          mkdir -p build
          cd build
          /opt/devkitpro/portlibs/switch/bin/aarch64-none-elf-cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DREVC_AUDIO=OAL \
            -DLIBRW_PLATFORM=GL3 \
            -DLIBRW_GL3_GFXLIB=GLFW \
            -DREVC_WITH_OPUS=False \
            -DREVC_VENDORED_LIBRW=True \
            -DREVC_INSTALL=True \
            ..
          cmake --build . --parallel $(nproc) --config Release
          
      - name: Create binary package (cpack)
        working-directory: ./build
        run: |
          cpack -G TXZ
          
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: "switch-gl3-miami"
          path: build/*.tar.xz
          if-no-files-found: error
